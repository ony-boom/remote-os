name: ğŸš€ Auto Deploy Apps
on:
  repository_dispatch:
    types: [app-updated]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App to update (or "all" for everything)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mms
          - ony-world

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ¯ Deployment Info
        run: |
          APP_NAME="${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          COMMIT="${{ github.event.client_payload.commit }}"
          AUTHOR="${{ github.event.client_payload.author }}"
          echo "::notice title=Starting Deployment::ğŸš€ Deploying $APP_NAME"
          if [ -n "$COMMIT" ]; then
            echo "::notice title=Trigger Info::ğŸ“ Commit: $COMMIT by $AUTHOR"
          fi
        
      - name: ğŸ“¥ Checkout repository  
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ“¦ Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          logger: pretty
          
      - name: âš¡ Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        
      - name: ğŸ”§ Install Colmena
        run: |
          echo "::group::Installing Colmena"
          nix profile add github:zhaofengli/colmena
          echo "::endgroup::"
          
      - name: ğŸ”„ Update Flake Inputs
        working-directory: ./config
        run: |
          APP_NAME="${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          echo "::group::ğŸ“¦ Updating flake inputs for: $APP_NAME"
          
          if [ "$APP_NAME" = "all" ]; then
            echo "ğŸ”„ Updating ALL flake inputs..."
            nix flake update --commit-lock-file
          else
            echo "ğŸ”„ Updating flake input: $APP_NAME"
            nix flake update "$APP_NAME" --commit-lock-file
          fi
          
          # Show what changed
          echo "ğŸ“‹ Changes made:"
          git show --stat HEAD
          echo "::endgroup::"
          
      - name: âœ… Validate Configuration
        working-directory: ./config
        run: |
          echo "::group::ğŸ§ª Validating NixOS configuration"
          nix flake check --show-trace
          echo "::endgroup::"
          
      - name: ğŸš¢ Deploy with Colmena
        working-directory: ./config
        run: |
          echo "::group::ğŸš€ Starting Colmena deployment"
          
          # Add SSH key if needed (uncomment and add SSH_PRIVATE_KEY secret)
          # mkdir -p ~/.ssh
          # echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          # chmod 600 ~/.ssh/id_rsa
          
          colmena apply --verbose --show-trace --on @target || {
            echo "::error title=Deployment Failed::âŒ Colmena deployment failed"
            exit 1
          }
          echo "::endgroup::"
          
      - name: ğŸ‰ Success Notification
        if: success()
        run: |
          APP_NAME="${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          echo "::notice title=Deployment Successful::âœ… Successfully deployed $APP_NAME to VPS!"
          
      - name: ğŸ’¥ Failure Notification  
        if: failure()
        run: |
          APP_NAME="${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          echo "::error title=Deployment Failed::âŒ Failed to deploy $APP_NAME. Check logs above for details."
